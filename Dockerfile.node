################################################################################
FROM ubuntu:20.04 as builder
ARG deps_dir

RUN apt-get update && \
    DEBIAN_FRONTEND=noninteractive apt-get -y install \
            build-essential             \
            cmake                       \
            curl                        \
            g++-8                       \
            git                         \
            libcurl4-openssl-dev        \
            libgmp-dev                  \
            libssl-dev                  \
            libusb-1.0-0-dev            \
            llvm-7-dev                  \
            pkg-config                  \
            python3                     \
            zlib1g-dev &&               \
    rm -rf /var/lib/apt/lists/*

WORKDIR /tmp/wax-blockchain
COPY ${deps_dir}/wax-blockchain .
RUN curl -L https://boostorg.jfrog.io/artifactory/main/release/1.70.0/source/boost_1_70_0.tar.bz2 | tar jx && \
    cd boost_1_70_0 &&                                                                                     \
    ./bootstrap.sh --prefix=$HOME/boost1.70 &&                                                             \
    ./b2 --with-iostreams --with-date_time --with-filesystem --with-system                                 \
        --with-program_options --with-chrono --with-test -j$(nproc) install &&                             \
    cd .. &&                                                                                               \
    scripts/install_deps.sh     &&                                                                         \
    scripts/pinned_build.sh deps build $(nproc)
    
###############################################################################    
FROM ubuntu:18.04
ARG deps_dir

RUN apt-get update && \
    DEBIAN_FRONTEND=noninteractive apt-get install -y \
        libssl-dev \
        libusb-1.0-0-dev \
        libcurl4-gnutls-dev && \
    rm -rf /var/lib/apt/lists/*
WORKDIR /usr/local/wax-blockchain

COPY --from=builder /tmp/wax-blockchain/build/bin   /usr/local/wax-blockchain/bin
COPY --from=builder /tmp/wax-blockchain/build/licenses   /usr/local/wax-blockchain/licenses

ENV EOSIO_ROOT=/usr/local/wax-blockchain
ENV PATH="/usr/local/wax-blockchain/bin:${PATH}"